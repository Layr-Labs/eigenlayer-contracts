name: Run Parallel Tests

on:
  push:
  pull_request:
    types: [opened, reopened]

defaults:
  run:
    shell: sh

jobs:
  test-suite:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foundry-rs/foundry:stable
    strategy:
      matrix:
        suite: [unit, integration, fork]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Forge dependencies
        run: forge install

      - name: Forge build
        run: |
          forge --version
          forge build

      - name: Run ${{ matrix.suite }} tests
        run: |
          case "${{ matrix.suite }}" in
            unit) forge test --no-match-contract Integration ;;
            integration) forge test --match-contract Integration ;;
            fork) forge test --match-contract Integration ;;
          esac
        env:
          FOUNDRY_PROFILE: ${{ matrix.suite == 'fork' && 'forktest' || '' }}
          RPC_MAINNET: ${{ secrets.RPC_MAINNET }}
          RPC_HOLESKY: ${{ secrets.RPC_HOLESKY }}
          CHAIN_ID: ${{ secrets.CHAIN_ID }}
